<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-extensions/observability/configuration" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Observability Configuration | NPipeline</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://npipeline.dev/docs/extensions/observability/configuration"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Observability Configuration | NPipeline"><meta data-rh="true" name="description" content="Detailed guide to configuring NPipeline observability with dependency injection, custom sinks, and advanced scenarios."><meta data-rh="true" property="og:description" content="Detailed guide to configuring NPipeline observability with dependency injection, custom sinks, and advanced scenarios."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://npipeline.dev/docs/extensions/observability/configuration"><link data-rh="true" rel="alternate" href="https://npipeline.dev/docs/extensions/observability/configuration" hreflang="en"><link data-rh="true" rel="alternate" href="https://npipeline.dev/docs/extensions/observability/configuration" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Extensions","item":"https://npipeline.dev/docs/extensions"},{"@type":"ListItem","position":2,"name":"NPipeline Observability Extension","item":"https://npipeline.dev/docs/extensions/observability/"},{"@type":"ListItem","position":3,"name":"Observability Configuration","item":"https://npipeline.dev/docs/extensions/observability/configuration"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="NPipeline RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="NPipeline Atom Feed">





<script src="//script.crazyegg.com/pages/scripts/0131/6841.js" async="async"></script><link rel="stylesheet" href="/assets/css/styles.4bb8ba71.css">
<script src="/assets/js/runtime~main.9d7dd1f4.js" defer="defer"></script>
<script src="/assets/js/main.b300061e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="NPipeline logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="NPipeline logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">NPipeline</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/npipeline/npipeline" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/"><span title="Welcome to NPipeline" class="linkLabel_WmDU">Welcome to NPipeline</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/getting-started"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/core-concepts"><span title="Core Concepts" class="categoryLinkLabel_W154">Core Concepts</span></a><button aria-label="Expand sidebar category &#x27;Core Concepts&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/architecture/"><span title="Architecture" class="categoryLinkLabel_W154">Architecture</span></a><button aria-label="Collapse sidebar category &#x27;Architecture&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/architectural-foundations"><span title="Architectural Foundations" class="linkLabel_WmDU">Architectural Foundations</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/component-architecture"><span title="Component Architecture" class="linkLabel_WmDU">Component Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/execution-flow"><span title="Execution Flow" class="linkLabel_WmDU">Execution Flow</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/data-flow"><span title="Data Flow Details" class="linkLabel_WmDU">Data Flow Details</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/dependency-injection"><span title="Dependency Injection Integration" class="linkLabel_WmDU">Dependency Injection Integration</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/node-instantiation"><span title="Node Instantiation" class="linkLabel_WmDU">Node Instantiation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/error-handling-architecture"><span title="Error Handling Architecture" class="linkLabel_WmDU">Error Handling Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/cancellation-model"><span title="Cancellation Model" class="linkLabel_WmDU">Cancellation Model</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/performance-characteristics"><span title="Performance Characteristics" class="linkLabel_WmDU">Performance Characteristics</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/retry-delay-architecture"><span title="Retry Delay Strategies Architecture" class="linkLabel_WmDU">Retry Delay Strategies Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/extension-points"><span title="Extension Points" class="linkLabel_WmDU">Extension Points</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/design-principles"><span title="Design Principles" class="linkLabel_WmDU">Design Principles</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/optimization-principles"><span title="Optimization Principles - How NPipeline Achieves High Performance" class="linkLabel_WmDU">Optimization Principles - How NPipeline Achieves High Performance</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/execution-plan-caching"><span title="Execution Plan Caching" class="linkLabel_WmDU">Execution Plan Caching</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/docs/extensions"><span title="Extensions" class="categoryLinkLabel_W154">Extensions</span></a><button aria-label="Collapse sidebar category &#x27;Extensions&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/dependency-injection"><span title="Dependency Injection" class="linkLabel_WmDU">Dependency Injection</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/parallelism"><span title="Parallelism" class="linkLabel_WmDU">Parallelism</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/extensions/testing"><span title="Testing" class="categoryLinkLabel_W154">Testing</span></a><button aria-label="Expand sidebar category &#x27;Testing&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/extensions/nodes"><span title="Nodes Extension" class="categoryLinkLabel_W154">Nodes Extension</span></a><button aria-label="Expand sidebar category &#x27;Nodes Extension&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/lineage"><span title="Lineage" class="categoryLinkLabel_W154">Lineage</span></a><button aria-label="Expand sidebar category &#x27;Lineage&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/lineage"><span title="NPipeline Lineage Extension" class="linkLabel_WmDU">NPipeline Lineage Extension</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/extensions/composition/"><span title="Pipeline Composition Extension" class="categoryLinkLabel_W154">Pipeline Composition Extension</span></a><button aria-label="Expand sidebar category &#x27;Pipeline Composition Extension&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/extensions/observability/"><span title="NPipeline Observability Extension" class="categoryLinkLabel_W154">NPipeline Observability Extension</span></a><button aria-label="Collapse sidebar category &#x27;NPipeline Observability Extension&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/observability/opentelemetry"><span title="OpenTelemetry Integration" class="linkLabel_WmDU">OpenTelemetry Integration</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/observability/tracing"><span title="Distributed Tracing" class="linkLabel_WmDU">Distributed Tracing</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/observability/advanced-patterns"><span title="Advanced Observability Patterns" class="linkLabel_WmDU">Advanced Observability Patterns</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/extensions/observability/configuration"><span title="Observability Configuration" class="linkLabel_WmDU">Observability Configuration</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/observability/examples"><span title="Observability Usage Examples" class="linkLabel_WmDU">Observability Usage Examples</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/observability/metrics"><span title="Metrics Reference" class="linkLabel_WmDU">Metrics Reference</span></a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/connectors"><span title="Connectors" class="categoryLinkLabel_W154">Connectors</span></a><button aria-label="Expand sidebar category &#x27;Connectors&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/advanced-topics"><span title="Advanced Topics" class="categoryLinkLabel_W154">Advanced Topics</span></a><button aria-label="Expand sidebar category &#x27;Advanced Topics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/analyzers/"><span title="Build-Time Analyzers" class="categoryLinkLabel_W154">Build-Time Analyzers</span></a><button aria-label="Expand sidebar category &#x27;Build-Time Analyzers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/samples/"><span title="Samples" class="categoryLinkLabel_W154">Samples</span></a><button aria-label="Expand sidebar category &#x27;Samples&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/reference"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a><button aria-label="Expand sidebar category &#x27;Reference&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/extensions"><span>Extensions</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/extensions/observability/"><span>NPipeline Observability Extension</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Observability Configuration</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Observability Configuration</h1></header>
<p>This guide covers all configuration options for the NPipeline Observability extension, including dependency injection registration, custom metrics sinks, and integration patterns.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="quick-start-automatic-metrics-collection">Quick Start: Automatic Metrics Collection<a href="#quick-start-automatic-metrics-collection" class="hash-link" aria-label="Direct link to Quick Start: Automatic Metrics Collection" title="Direct link to Quick Start: Automatic Metrics Collection" translate="no">​</a></h2>
<p>The simplest way to enable observability is to use the <code>IObservablePipelineContextFactory</code>:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.Hosting;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var host = Host.CreateDefaultBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .ConfigureServices((context, services) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipelineObservability(); // Registers everything automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipeline(Assembly.GetExecutingAssembly());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Create context with observability pre-configured</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">await using var scope = host.Services.CreateAsyncScope();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var contextFactory = scope.ServiceProvider.GetRequiredService&lt;IObservablePipelineContextFactory&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">await using var context = contextFactory.Create(); // ExecutionObserver is already set!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var runner = scope.ServiceProvider.GetRequiredService&lt;IPipelineRunner&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">await runner.RunAsync&lt;MyPipeline&gt;(context);</span><br></span></code></pre></div></div>
<p>No need to manually create or wire up <code>MetricsCollectingExecutionObserver</code> - it&#x27;s all handled automatically!</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="registration-methods">Registration Methods<a href="#registration-methods" class="hash-link" aria-label="Direct link to Registration Methods" title="Direct link to Registration Methods" translate="no">​</a></h2>
<p>The extension provides multiple registration methods to accommodate different scenarios and requirements.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-default-registration-with-logging-sinks">1. Default Registration with Logging Sinks<a href="#1-default-registration-with-logging-sinks" class="hash-link" aria-label="Direct link to 1. Default Registration with Logging Sinks" title="Direct link to 1. Default Registration with Logging Sinks" translate="no">​</a></h3>
<p>The simplest approach uses built-in logging sinks that output metrics to <code>ILogger</code>:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Register with default logging sinks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddNPipelineObservability();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Register NPipeline core services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddNPipeline(Assembly.GetExecutingAssembly());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var serviceProvider = services.BuildServiceProvider();</span><br></span></code></pre></div></div>
<p><strong>What gets registered:</strong></p>
<ul>
<li class=""><code>IObservabilityCollector</code> (scoped) - collects metrics during execution</li>
<li class=""><code>IExecutionObserver</code> (scoped) - automatically wired to observer pipeline events</li>
<li class=""><code>IObservablePipelineContextFactory</code> (scoped) - creates contexts with observability enabled</li>
<li class=""><code>IMetricsSink</code> → <code>LoggingMetricsSink</code> (transient) - outputs metrics via ILogger</li>
<li class=""><code>IPipelineMetricsSink</code> → <code>LoggingPipelineMetricsSink</code> (transient) - outputs pipeline-level metrics</li>
<li class=""><code>IObservabilityFactory</code> → <code>DiObservabilityFactory</code> (scoped) - factory for sink resolution</li>
</ul>
<p><strong>Use when:</strong></p>
<ul>
<li class="">You want quick observability without additional infrastructure</li>
<li class="">You&#x27;re already using structured logging (Serilog, NLog, etc.)</li>
<li class="">You need metrics for local development or debugging</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-custom-metrics-sinks">2. Custom Metrics Sinks<a href="#2-custom-metrics-sinks" class="hash-link" aria-label="Direct link to 2. Custom Metrics Sinks" title="Direct link to 2. Custom Metrics Sinks" translate="no">​</a></h3>
<p>Register your own implementations of metrics sinks:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.Metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Register with custom sinks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddNPipelineObservability&lt;CustomMetricsSink, CustomPipelineMetricsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Register your custom sinks if they have dependencies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddSingleton&lt;ITelemetryClient, TelemetryClient&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddTransient&lt;CustomMetricsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddTransient&lt;CustomPipelineMetricsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var serviceProvider = services.BuildServiceProvider();</span><br></span></code></pre></div></div>
<p><strong>Custom sink implementations:</strong></p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class CustomMetricsSink : IMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ITelemetryClient _telemetryClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CustomMetricsSink(ITelemetryClient telemetryClient)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _telemetryClient = telemetryClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Emit metrics to your monitoring system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var properties = new Dictionary&lt;string, string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;NodeId&quot;] = nodeMetrics.NodeId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;Success&quot;] = nodeMetrics.Success.ToString()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var metrics = new Dictionary&lt;string, double&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;DurationMs&quot;] = nodeMetrics.DurationMs ?? 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;ItemsProcessed&quot;] = nodeMetrics.ItemsProcessed,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;Throughput&quot;] = nodeMetrics.ThroughputItemsPerSec ?? 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _telemetryClient.TrackEvent(&quot;NodeCompleted&quot;, properties, metrics);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class CustomPipelineMetricsSink : IPipelineMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ITelemetryClient _telemetryClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CustomPipelineMetricsSink(ITelemetryClient telemetryClient)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _telemetryClient = telemetryClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Task RecordAsync(IPipelineMetrics pipelineMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var properties = new Dictionary&lt;string, string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;PipelineName&quot;] = pipelineMetrics.PipelineName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;RunId&quot;] = pipelineMetrics.RunId.ToString(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;Success&quot;] = pipelineMetrics.Success.ToString()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var metrics = new Dictionary&lt;string, double&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;DurationMs&quot;] = pipelineMetrics.DurationMs ?? 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;TotalItemsProcessed&quot;] = pipelineMetrics.TotalItemsProcessed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _telemetryClient.TrackEvent(&quot;PipelineCompleted&quot;, properties, metrics);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Use when:</strong></p>
<ul>
<li class="">You need to integrate with Application Insights, Prometheus, OpenTelemetry, or other monitoring systems</li>
<li class="">You want to transform or enrich metrics before emission</li>
<li class="">You need to send metrics to multiple destinations</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-factory-delegate-registration">3. Factory Delegate Registration<a href="#3-factory-delegate-registration" class="hash-link" aria-label="Direct link to 3. Factory Delegate Registration" title="Direct link to 3. Factory Delegate Registration" translate="no">​</a></h3>
<p>Use factory delegates for complex initialization scenarios:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.Metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Register with factory delegates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddNPipelineObservability(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metricsSinkFactory: serviceProvider =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var logger = serviceProvider.GetRequiredService&lt;ILogger&lt;CustomMetricsSink&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var config = serviceProvider.GetRequiredService&lt;IConfiguration&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var endpoint = config[&quot;Metrics:Endpoint&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new CustomMetricsSink(logger, endpoint);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pipelineMetricsSinkFactory: serviceProvider =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var logger = serviceProvider.GetRequiredService&lt;ILogger&lt;CustomPipelineMetricsSink&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var config = serviceProvider.GetRequiredService&lt;IConfiguration&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var endpoint = config[&quot;Metrics:PipelineEndpoint&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new CustomPipelineMetricsSink(logger, endpoint);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var serviceProvider = services.BuildServiceProvider();</span><br></span></code></pre></div></div>
<p><strong>Use when:</strong></p>
<ul>
<li class="">Your sinks require complex initialization logic</li>
<li class="">You need to resolve multiple dependencies from the service provider</li>
<li class="">You want to conditionally create sinks based on configuration</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-custom-collector-implementation">4. Custom Collector Implementation<a href="#4-custom-collector-implementation" class="hash-link" aria-label="Direct link to 4. Custom Collector Implementation" title="Direct link to 4. Custom Collector Implementation" translate="no">​</a></h3>
<p>For specialized metrics collection scenarios, provide your own collector:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.Metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Custom collector implementation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class CustomObservabilityCollector : IObservabilityCollector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ObservabilityCollector _baseCollector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ILogger _logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CustomObservabilityCollector(ILogger&lt;CustomObservabilityCollector&gt; logger)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector = new ObservabilityCollector();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger = logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void RecordNodeStart(string nodeId, DateTimeOffset timestamp, int? threadId = null, long? initialMemoryMb = null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogInformation(&quot;Node {NodeId} started at {Timestamp}&quot;, nodeId, timestamp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector.RecordNodeStart(nodeId, timestamp, threadId, initialMemoryMb);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void RecordNodeEnd(string nodeId, DateTimeOffset timestamp, bool success, Exception? exception = null, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long? peakMemoryMb = null, long? processorTimeMs = null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector.RecordNodeEnd(nodeId, timestamp, success, exception, peakMemoryMb, processorTimeMs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!success)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _logger.LogError(exception, &quot;Node {NodeId} failed&quot;, nodeId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void RecordItemMetrics(string nodeId, long itemsProcessed, long itemsEmitted)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector.RecordItemMetrics(nodeId, itemsProcessed, itemsEmitted);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void RecordRetry(string nodeId, int retryCount, string? reason = null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogWarning(&quot;Node {NodeId} retry attempt {RetryCount}. Reason: {Reason}&quot;, nodeId, retryCount, reason);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector.RecordRetry(nodeId, retryCount, reason);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void RecordPerformanceMetrics(string nodeId, double throughputItemsPerSec, double averageItemProcessingMs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector.RecordPerformanceMetrics(nodeId, throughputItemsPerSec, averageItemProcessingMs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IReadOnlyList&lt;INodeMetrics&gt; GetNodeMetrics()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return _baseCollector.GetNodeMetrics();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public INodeMetrics? GetNodeMetrics(string nodeId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return _baseCollector.GetNodeMetrics(nodeId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IPipelineMetrics CreatePipelineMetrics(string pipelineName, Guid runId, DateTimeOffset startTime, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DateTimeOffset? endTime, bool success, Exception? exception = null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return _baseCollector.CreatePipelineMetrics(pipelineName, runId, startTime, endTime, success, exception);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Registration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddNPipelineObservability&lt;CustomObservabilityCollector, LoggingMetricsSink, LoggingPipelineMetricsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var serviceProvider = services.BuildServiceProvider();</span><br></span></code></pre></div></div>
<p><strong>Use when:</strong></p>
<ul>
<li class="">You need to add custom logging or side effects during metrics collection</li>
<li class="">You want to transform or filter metrics before they&#x27;re stored</li>
<li class="">You need to integrate with custom observability infrastructure</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-custom-collector-with-factory-delegate">5. Custom Collector with Factory Delegate<a href="#5-custom-collector-with-factory-delegate" class="hash-link" aria-label="Direct link to 5. Custom Collector with Factory Delegate" title="Direct link to 5. Custom Collector with Factory Delegate" translate="no">​</a></h3>
<p>Combine custom collector with factory delegate initialization:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">services.AddNPipelineObservability&lt;LoggingMetricsSink, LoggingPipelineMetricsSink&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    collectorFactory: serviceProvider =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var logger = serviceProvider.GetRequiredService&lt;ILogger&lt;CustomObservabilityCollector&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var config = serviceProvider.GetRequiredService&lt;IConfiguration&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var enableDetailedMetrics = config.GetValue&lt;bool&gt;(&quot;Observability:DetailedMetrics&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new CustomObservabilityCollector(logger, enableDetailedMetrics);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="service-lifetimes">Service Lifetimes<a href="#service-lifetimes" class="hash-link" aria-label="Direct link to Service Lifetimes" title="Direct link to Service Lifetimes" translate="no">​</a></h2>
<p>Understanding service lifetimes is crucial for proper configuration:</p>
<table><thead><tr><th>Service</th><th>Default Lifetime</th><th>Rationale</th></tr></thead><tbody><tr><td><code>IObservabilityCollector</code></td><td>Scoped</td><td>One instance per pipeline run for isolation</td></tr><tr><td><code>IMetricsSink</code></td><td>Scoped</td><td>New instance per pipeline run to avoid state sharing</td></tr><tr><td><code>IPipelineMetricsSink</code></td><td>Scoped</td><td>New instance per pipeline run to avoid state sharing</td></tr><tr><td><code>IObservabilityFactory</code></td><td>Scoped</td><td>Resolves scoped collector instances</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-scoped-collector">Why Scoped Collector?<a href="#why-scoped-collector" class="hash-link" aria-label="Direct link to Why Scoped Collector?" title="Direct link to Why Scoped Collector?" translate="no">​</a></h3>
<p>The collector is scoped to ensure:</p>
<ul>
<li class=""><strong>Isolation</strong>: Each pipeline run gets its own metrics, preventing cross-contamination</li>
<li class=""><strong>Memory management</strong>: Metrics are automatically disposed when the scope ends</li>
<li class=""><strong>Thread safety</strong>: Concurrent pipeline runs don&#x27;t interfere with each other</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-scoped-sinks">Why Scoped Sinks?<a href="#why-scoped-sinks" class="hash-link" aria-label="Direct link to Why Scoped Sinks?" title="Direct link to Why Scoped Sinks?" translate="no">​</a></h3>
<p>Sinks are scoped because:</p>
<ul>
<li class=""><strong>Stateless operation</strong>: Most sinks don&#x27;t maintain state between uses</li>
<li class=""><strong>Dependency resolution</strong>: Allows sinks to receive scoped dependencies</li>
<li class=""><strong>Flexibility</strong>: Enables different sink instances for different pipeline runs</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuration-options">Configuration Options<a href="#configuration-options" class="hash-link" aria-label="Direct link to Configuration Options" title="Direct link to Configuration Options" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="observabilityextensionoptions">ObservabilityExtensionOptions<a href="#observabilityextensionoptions" class="hash-link" aria-label="Direct link to ObservabilityExtensionOptions" title="Direct link to ObservabilityExtensionOptions" translate="no">​</a></h3>
<p>The <a class="" href="/docs/src/NPipeline.Extensions.Observability/DependencyInjection/ObservabilityExtensionOptions.cs:10"><code>ObservabilityExtensionOptions</code></a> class controls global behavior of the observability extension:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed record ObservabilityExtensionOptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Whether to automatically collect memory metrics (peak memory usage) for each node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool EnableMemoryMetrics { get; init; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Default observability extension options with memory metrics disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ObservabilityExtensionOptions Default =&gt; new() { EnableMemoryMetrics = false };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Observability extension options with memory metrics enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ObservabilityExtensionOptions WithMemoryMetrics =&gt; new() { EnableMemoryMetrics = true };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Default</strong>: <code>EnableMemoryMetrics = false</code> (memory metrics disabled by default)</p>
<p><strong>Important</strong>: Memory metrics require BOTH:</p>
<ol>
<li class="">Extension-level configuration: <code>services.AddNPipelineObservability(ObservabilityExtensionOptions.WithMemoryMetrics)</code></li>
<li class="">Node-level configuration: <code>.WithObservability(builder, ObservabilityOptions.Full)</code> or set <code>RecordMemoryUsage = true</code></li>
</ol>
<p>If either level is disabled, memory metrics will not be collected.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="default-configuration-logging-sinks">Default Configuration (Logging Sinks)<a href="#default-configuration-logging-sinks" class="hash-link" aria-label="Direct link to Default Configuration (Logging Sinks)" title="Direct link to Default Configuration (Logging Sinks)" translate="no">​</a></h3>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="conditional-registration">Conditional Registration<a href="#conditional-registration" class="hash-link" aria-label="Direct link to Conditional Registration" title="Direct link to Conditional Registration" translate="no">​</a></h3>
<p>Enable observability based on configuration:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var configuration = new ConfigurationBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .AddJsonFile(&quot;appsettings.json&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var enableObservability = configuration.GetValue&lt;bool&gt;(&quot;Observability:Enabled&quot;, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (enableObservability)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    services.AddNPipelineObservability();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="multiple-sinks">Multiple Sinks<a href="#multiple-sinks" class="hash-link" aria-label="Direct link to Multiple Sinks" title="Direct link to Multiple Sinks" translate="no">​</a></h3>
<p>Send metrics to multiple destinations by implementing composite sinks:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class CompositeMetricsSink : IMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IEnumerable&lt;IMetricsSink&gt; _sinks;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CompositeMetricsSink(IEnumerable&lt;IMetricsSink&gt; sinks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _sinks = sinks;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var tasks = _sinks.Select(sink =&gt; sink.RecordAsync(nodeMetrics, cancellationToken));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await Task.WhenAll(tasks);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Register multiple sinks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddSingleton&lt;IMetricsSink, LoggingMetricsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddSingleton&lt;IMetricsSink, ApplicationInsightsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddSingleton&lt;IMetricsSink, PrometheusSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Register composite sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddNPipelineObservability&lt;CompositeMetricsSink, LoggingPipelineMetricsSink&gt;();</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuration-based-sink-selection">Configuration-Based Sink Selection<a href="#configuration-based-sink-selection" class="hash-link" aria-label="Direct link to Configuration-Based Sink Selection" title="Direct link to Configuration-Based Sink Selection" translate="no">​</a></h3>
<p>Choose sinks based on configuration:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">services.AddNPipelineObservability(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metricsSinkFactory: serviceProvider =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var config = serviceProvider.GetRequiredService&lt;IConfiguration&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var sinkType = config[&quot;Observability:SinkType&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return sinkType switch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Logging&quot; =&gt; new LoggingMetricsSink(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;ApplicationInsights&quot; =&gt; new ApplicationInsightsSink(/* ... */),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Prometheus&quot; =&gt; new PrometheusSink(/* ... */),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _ =&gt; throw new InvalidOperationException($&quot;Unknown sink type: {sinkType}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pipelineMetricsSinkFactory: serviceProvider =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var config = serviceProvider.GetRequiredService&lt;IConfiguration&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var sinkType = config[&quot;Observability:PipelineSinkType&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return sinkType switch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Logging&quot; =&gt; new LoggingPipelineMetricsSink(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;ApplicationInsights&quot; =&gt; new ApplicationInsightsPipelineSink(/* ... */),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _ =&gt; throw new InvalidOperationException($&quot;Unknown sink type: {sinkType}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="integration-with-existing-logging-infrastructure">Integration with Existing Logging Infrastructure<a href="#integration-with-existing-logging-infrastructure" class="hash-link" aria-label="Direct link to Integration with Existing Logging Infrastructure" title="Direct link to Integration with Existing Logging Infrastructure" translate="no">​</a></h2>
<p>The extension integrates seamlessly with Microsoft.Extensions.Logging:</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="structured-logging-with-serilog">Structured Logging with Serilog<a href="#structured-logging-with-serilog" class="hash-link" aria-label="Direct link to Structured Logging with Serilog" title="Direct link to Structured Logging with Serilog" translate="no">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Serilog;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Log.Logger = new LoggerConfiguration()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .WriteTo.Console()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .WriteTo.File(&quot;logs/pipeline-.txt&quot;, rollingInterval: RollingInterval.Day)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .CreateLogger();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddLogging(loggingBuilder =&gt; loggingBuilder.AddSerilog());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.AddNPipelineObservability();</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="enriching-logs-with-context">Enriching Logs with Context<a href="#enriching-logs-with-context" class="hash-link" aria-label="Direct link to Enriching Logs with Context" title="Direct link to Enriching Logs with Context" translate="no">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class EnrichedLoggingMetricsSink : IMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ILogger _logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IHttpContextAccessor _httpContextAccessor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EnrichedLoggingMetricsSink(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ILogger&lt;EnrichedLoggingMetricsSink&gt; logger,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IHttpContextAccessor httpContextAccessor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger = logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _httpContextAccessor = httpContextAccessor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var correlationId = _httpContextAccessor.HttpContext?.TraceIdentifier;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        using (_logger.BeginScope(new Dictionary&lt;string, object?&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;NodeId&quot;] = nodeMetrics.NodeId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;Success&quot;] = nodeMetrics.Success,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;CorrelationId&quot;] = correlationId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _logger.LogInformation(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Node {NodeId} completed. Processed {ItemsProcessed} items in {DurationMs}ms&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.NodeId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.ItemsProcessed,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.DurationMs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="best-practices">Best Practices<a href="#best-practices" class="hash-link" aria-label="Direct link to Best Practices" title="Direct link to Best Practices" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-use-appropriate-service-lifetimes">1. Use Appropriate Service Lifetimes<a href="#1-use-appropriate-service-lifetimes" class="hash-link" aria-label="Direct link to 1. Use Appropriate Service Lifetimes" title="Direct link to 1. Use Appropriate Service Lifetimes" translate="no">​</a></h3>
<ul>
<li class="">Keep collectors scoped for pipeline isolation</li>
<li class="">Use transient sinks to avoid state sharing</li>
<li class="">Register singleton sinks only if they&#x27;re truly stateless</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-handle-cancellation">2. Handle Cancellation<a href="#2-handle-cancellation" class="hash-link" aria-label="Direct link to 2. Handle Cancellation" title="Direct link to 2. Handle Cancellation" translate="no">​</a></h3>
<p>Always respect cancellation tokens in async sink implementations:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await _telemetryClient.TrackEventAsync(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;NodeCompleted&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            metrics,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cancellationToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (OperationCanceledException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Log cancellation and exit gracefully</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogWarning(&quot;Metrics recording cancelled&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-implement-retry-logic-for-external-systems">3. Implement Retry Logic for External Systems<a href="#3-implement-retry-logic-for-external-systems" class="hash-link" aria-label="Direct link to 3. Implement Retry Logic for External Systems" title="Direct link to 3. Implement Retry Logic for External Systems" translate="no">​</a></h3>
<p>When sending metrics to external systems, implement retry logic:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class ResilientMetricsSink : IMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ITelemetryClient _telemetryClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ILogger _logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly AsyncRetryPolicy _retryPolicy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ResilientMetricsSink(ITelemetryClient telemetryClient, ILogger&lt;ResilientMetricsSink&gt; logger)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _telemetryClient = telemetryClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger = logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _retryPolicy = Policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .Handle&lt;Exception&gt;()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .WaitAndRetryAsync(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                retryCount: 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sleepDurationProvider: retryAttempt =&gt; TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                onRetry: (exception, timeSpan, retryCount, context) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    _logger.LogWarning(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        exception,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Retry {RetryCount} after {Delay}s for metrics recording&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        retryCount,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        timeSpan.TotalSeconds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await _retryPolicy.ExecuteAsync(async () =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await _telemetryClient.TrackEventAsync(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;NodeCompleted&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CreateProperties(nodeMetrics),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CreateMetrics(nodeMetrics),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cancellationToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-filter-metrics-in-development">4. Filter Metrics in Development<a href="#4-filter-metrics-in-development" class="hash-link" aria-label="Direct link to 4. Filter Metrics in Development" title="Direct link to 4. Filter Metrics in Development" translate="no">​</a></h3>
<p>Reduce noise in development environments:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class DevelopmentMetricsSink : IMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IMetricsSink _innerSink;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly bool _isDevelopment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DevelopmentMetricsSink(IMetricsSink innerSink, IHostEnvironment environment)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _innerSink = innerSink;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _isDevelopment = environment.IsDevelopment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (_isDevelopment)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Only log errors and warnings in development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!nodeMetrics.Success || nodeMetrics.RetryCount &gt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                await _innerSink.RecordAsync(nodeMetrics, cancellationToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Log everything in production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await _innerSink.RecordAsync(nodeMetrics, cancellationToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-aggregate-metrics-for-high-volume-scenarios">5. Aggregate Metrics for High-Volume Scenarios<a href="#5-aggregate-metrics-for-high-volume-scenarios" class="hash-link" aria-label="Direct link to 5. Aggregate Metrics for High-Volume Scenarios" title="Direct link to 5. Aggregate Metrics for High-Volume Scenarios" translate="no">​</a></h3>
<p>For high-throughput pipelines, aggregate metrics before emission:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class AggregatingMetricsSink : IMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ConcurrentDictionary&lt;string, AggregatedMetrics&gt; _aggregates = new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly Timer _flushTimer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IMetricsSink _innerSink;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AggregatingMetricsSink(IMetricsSink innerSink)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _innerSink = innerSink;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _flushTimer = new Timer(FlushAggregates, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var aggregate = _aggregates.GetOrAdd(nodeMetrics.NodeId, _ =&gt; new AggregatedMetrics());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aggregate.Add(nodeMetrics);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private async void FlushAggregates(object? state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var kvp in _aggregates)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var aggregatedMetrics = kvp.Value.Build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await _innerSink.RecordAsync(aggregatedMetrics, CancellationToken.None);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _aggregates.TryRemove(kvp.Key, out _);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="metrics-not-appearing">Metrics Not Appearing<a href="#metrics-not-appearing" class="hash-link" aria-label="Direct link to Metrics Not Appearing" title="Direct link to Metrics Not Appearing" translate="no">​</a></h3>
<p><strong>Problem</strong>: Metrics are not being logged or sent to external systems.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li class="">Verify observability is registered: <code>services.AddNPipelineObservability()</code></li>
<li class="">Check that the pipeline is using DI: <code>await serviceProvider.RunPipelineAsync&lt;T&gt;()</code></li>
<li class="">Ensure logging is configured properly</li>
<li class="">Verify sink implementations are not throwing exceptions</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="memory-leaks">Memory Leaks<a href="#memory-leaks" class="hash-link" aria-label="Direct link to Memory Leaks" title="Direct link to Memory Leaks" translate="no">​</a></h3>
<p><strong>Problem</strong>: Memory usage increases over time with long-running pipelines.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li class="">Ensure collectors are scoped, not singleton</li>
<li class="">Verify sinks are transient and don&#x27;t retain references</li>
<li class="">Check for circular dependencies in sink implementations</li>
<li class="">Review custom collector implementations for proper disposal</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="performance-degradation">Performance Degradation<a href="#performance-degradation" class="hash-link" aria-label="Direct link to Performance Degradation" title="Direct link to Performance Degradation" translate="no">​</a></h3>
<p><strong>Problem</strong>: Pipeline execution slows down when observability is enabled.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li class="">Use async sink implementations</li>
<li class="">Implement batching or aggregation for external calls</li>
<li class="">Consider disabling expensive metrics (memory, processor time) in production</li>
<li class="">Use sampling for high-volume scenarios</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="architecture-and-design">Architecture and Design<a href="#architecture-and-design" class="hash-link" aria-label="Direct link to Architecture and Design" title="Direct link to Architecture and Design" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="system-architecture">System Architecture<a href="#system-architecture" class="hash-link" aria-label="Direct link to System Architecture" title="Direct link to System Architecture" translate="no">​</a></h3>
<p>The extension follows a layered architecture for separation of concerns:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Pipeline Execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IExecutionObserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MetricsCollectingExecutionObserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IObservabilityCollector (Thread-safe)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├→ Node Metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └→ Pipeline Metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMetricsSink / IPipelineMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├→ LoggingMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├→ Custom Sinks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └→ Composite Sinks</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="key-components">Key Components<a href="#key-components" class="hash-link" aria-label="Direct link to Key Components" title="Direct link to Key Components" translate="no">​</a></h3>
<ul>
<li class=""><strong><code>MetricsCollectingExecutionObserver</code></strong>: Hooks into pipeline execution lifecycle to capture node start/end events and delegate to the collector</li>
<li class=""><strong><code>IObservabilityCollector</code></strong>: Thread-safe collector that aggregates metrics from all nodes and provides query interfaces</li>
<li class=""><strong><code>IMetricsSink</code> / <code>IPipelineMetricsSink</code></strong>: Abstractions for emitting metrics to various destinations (logging, monitoring systems, etc.)</li>
<li class=""><strong><code>IObservabilityFactory</code></strong>: DI-aware factory for resolving and configuring observability components</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="thread-safety-guarantees">Thread-Safety Guarantees<a href="#thread-safety-guarantees" class="hash-link" aria-label="Direct link to Thread-Safety Guarantees" title="Direct link to Thread-Safety Guarantees" translate="no">​</a></h3>
<p>The extension provides strong thread-safety guarantees for production environments:</p>
<ul>
<li class=""><strong>Concurrent metrics collection</strong>: Multiple nodes can record metrics simultaneously without race conditions</li>
<li class=""><strong>Atomic counter updates</strong>: Item counts use <code>Interlocked.Add</code> for thread-safe increments</li>
<li class=""><strong>Immutable metric records</strong>: Once built, metric records are immutable and safe to share across threads</li>
<li class=""><strong>Scoped isolation</strong>: Each pipeline run gets its own collector instance, preventing cross-contamination between runs</li>
<li class=""><strong>ConcurrentDictionary</strong>: Internal metrics storage uses <code>ConcurrentDictionary</code> for lock-free operations</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="performance-characteristics">Performance Characteristics<a href="#performance-characteristics" class="hash-link" aria-label="Direct link to Performance Characteristics" title="Direct link to Performance Characteristics" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="minimal-overhead">Minimal Overhead<a href="#minimal-overhead" class="hash-link" aria-label="Direct link to Minimal Overhead" title="Direct link to Minimal Overhead" translate="no">​</a></h3>
<p>The extension is designed for production use with minimal performance impact:</p>
<ul>
<li class=""><strong>Non-blocking metrics collection</strong>: Metrics are recorded asynchronously without blocking pipeline execution</li>
<li class=""><strong>Efficient data structures</strong>: Uses optimized collections (ConcurrentDictionary) for metrics aggregation</li>
<li class=""><strong>Optional observability</strong>: Can be disabled entirely by not registering the services</li>
<li class=""><strong>Scoped lifetime</strong>: Metrics are isolated per pipeline run, preventing memory leaks</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="memory-usage">Memory Usage<a href="#memory-usage" class="hash-link" aria-label="Direct link to Memory Usage" title="Direct link to Memory Usage" translate="no">​</a></h3>
<ul>
<li class=""><strong>Per-pipeline overhead</strong>: Approximately 1-2 KB per node for metrics storage</li>
<li class=""><strong>Transient sinks</strong>: Metrics sinks are created per pipeline run and disposed after use</li>
<li class=""><strong>No persistent storage</strong>: Metrics are not retained in memory beyond the pipeline execution scope</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="cpu-impact">CPU Impact<a href="#cpu-impact" class="hash-link" aria-label="Direct link to CPU Impact" title="Direct link to CPU Impact" translate="no">​</a></h3>
<ul>
<li class=""><strong>Lightweight timing</strong>: Uses high-resolution <code>Stopwatch</code> timers with minimal CPU overhead</li>
<li class=""><strong>Optional performance counters</strong>: Memory and processor time collection can be disabled if not needed via <code>ObservabilityOptions.Minimal</code></li>
<li class=""><strong>Batch-friendly</strong>: Metrics collection scales efficiently with large batch sizes and doesn&#x27;t degrade with parallelism</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="related-topics">Related Topics<a href="#related-topics" class="hash-link" aria-label="Direct link to Related Topics" title="Direct link to Related Topics" translate="no">​</a></h2>
<ul>
<li class=""><strong><a class="" href="/docs/extensions/observability/">Getting Started</a></strong>: Quick start and basic usage</li>
<li class=""><strong><a class="" href="/docs/extensions/observability/metrics">Metrics Reference</a></strong>: Detailed metrics documentation</li>
<li class=""><strong><a class="" href="/docs/extensions/observability/examples">Usage Examples</a></strong>: Complete code examples</li>
<li class=""><strong><a class="" href="/docs/extensions/observability/advanced-patterns">Advanced Patterns</a></strong>: Advanced scenarios and custom implementations</li>
<li class=""><strong><a class="" href="/docs/extensions/observability/tracing">Distributed Tracing</a></strong>: Core tracing abstraction</li>
</ul></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/extensions/observability/advanced-patterns"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Advanced Observability Patterns</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/extensions/observability/examples"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Observability Usage Examples</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#quick-start-automatic-metrics-collection" class="table-of-contents__link toc-highlight">Quick Start: Automatic Metrics Collection</a></li><li><a href="#registration-methods" class="table-of-contents__link toc-highlight">Registration Methods</a><ul><li><a href="#1-default-registration-with-logging-sinks" class="table-of-contents__link toc-highlight">1. Default Registration with Logging Sinks</a></li><li><a href="#2-custom-metrics-sinks" class="table-of-contents__link toc-highlight">2. Custom Metrics Sinks</a></li><li><a href="#3-factory-delegate-registration" class="table-of-contents__link toc-highlight">3. Factory Delegate Registration</a></li><li><a href="#4-custom-collector-implementation" class="table-of-contents__link toc-highlight">4. Custom Collector Implementation</a></li><li><a href="#5-custom-collector-with-factory-delegate" class="table-of-contents__link toc-highlight">5. Custom Collector with Factory Delegate</a></li></ul></li><li><a href="#service-lifetimes" class="table-of-contents__link toc-highlight">Service Lifetimes</a><ul><li><a href="#why-scoped-collector" class="table-of-contents__link toc-highlight">Why Scoped Collector?</a></li><li><a href="#why-scoped-sinks" class="table-of-contents__link toc-highlight">Why Scoped Sinks?</a></li></ul></li><li><a href="#configuration-options" class="table-of-contents__link toc-highlight">Configuration Options</a><ul><li><a href="#observabilityextensionoptions" class="table-of-contents__link toc-highlight">ObservabilityExtensionOptions</a></li><li><a href="#default-configuration-logging-sinks" class="table-of-contents__link toc-highlight">Default Configuration (Logging Sinks)</a></li><li><a href="#conditional-registration" class="table-of-contents__link toc-highlight">Conditional Registration</a></li><li><a href="#multiple-sinks" class="table-of-contents__link toc-highlight">Multiple Sinks</a></li><li><a href="#configuration-based-sink-selection" class="table-of-contents__link toc-highlight">Configuration-Based Sink Selection</a></li></ul></li><li><a href="#integration-with-existing-logging-infrastructure" class="table-of-contents__link toc-highlight">Integration with Existing Logging Infrastructure</a><ul><li><a href="#structured-logging-with-serilog" class="table-of-contents__link toc-highlight">Structured Logging with Serilog</a></li><li><a href="#enriching-logs-with-context" class="table-of-contents__link toc-highlight">Enriching Logs with Context</a></li></ul></li><li><a href="#best-practices" class="table-of-contents__link toc-highlight">Best Practices</a><ul><li><a href="#1-use-appropriate-service-lifetimes" class="table-of-contents__link toc-highlight">1. Use Appropriate Service Lifetimes</a></li><li><a href="#2-handle-cancellation" class="table-of-contents__link toc-highlight">2. Handle Cancellation</a></li><li><a href="#3-implement-retry-logic-for-external-systems" class="table-of-contents__link toc-highlight">3. Implement Retry Logic for External Systems</a></li><li><a href="#4-filter-metrics-in-development" class="table-of-contents__link toc-highlight">4. Filter Metrics in Development</a></li><li><a href="#5-aggregate-metrics-for-high-volume-scenarios" class="table-of-contents__link toc-highlight">5. Aggregate Metrics for High-Volume Scenarios</a></li></ul></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a><ul><li><a href="#metrics-not-appearing" class="table-of-contents__link toc-highlight">Metrics Not Appearing</a></li><li><a href="#memory-leaks" class="table-of-contents__link toc-highlight">Memory Leaks</a></li><li><a href="#performance-degradation" class="table-of-contents__link toc-highlight">Performance Degradation</a></li></ul></li><li><a href="#architecture-and-design" class="table-of-contents__link toc-highlight">Architecture and Design</a><ul><li><a href="#system-architecture" class="table-of-contents__link toc-highlight">System Architecture</a></li><li><a href="#key-components" class="table-of-contents__link toc-highlight">Key Components</a></li><li><a href="#thread-safety-guarantees" class="table-of-contents__link toc-highlight">Thread-Safety Guarantees</a></li></ul></li><li><a href="#performance-characteristics" class="table-of-contents__link toc-highlight">Performance Characteristics</a><ul><li><a href="#minimal-overhead" class="table-of-contents__link toc-highlight">Minimal Overhead</a></li><li><a href="#memory-usage" class="table-of-contents__link toc-highlight">Memory Usage</a></li><li><a href="#cpu-impact" class="table-of-contents__link toc-highlight">CPU Impact</a></li></ul></li><li><a href="#related-topics" class="table-of-contents__link toc-highlight">Related Topics</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/why-npipeline">Why NPipeline?</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/installation">Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/quick-start">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/core-concepts">Core Concepts</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/npipeline/npipeline" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">&nbsp;</div></div></div></footer></div>
</body>
</html>