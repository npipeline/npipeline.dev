<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-extensions/observability/examples" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Observability Usage Examples | NPipeline</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://npipeline.dev/docs/extensions/observability/examples"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Observability Usage Examples | NPipeline"><meta data-rh="true" name="description" content="Complete code examples demonstrating various scenarios for using NPipeline Observability extension, from basic setup to advanced monitoring patterns."><meta data-rh="true" property="og:description" content="Complete code examples demonstrating various scenarios for using NPipeline Observability extension, from basic setup to advanced monitoring patterns."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://npipeline.dev/docs/extensions/observability/examples"><link data-rh="true" rel="alternate" href="https://npipeline.dev/docs/extensions/observability/examples" hreflang="en"><link data-rh="true" rel="alternate" href="https://npipeline.dev/docs/extensions/observability/examples" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Extensions","item":"https://npipeline.dev/docs/extensions"},{"@type":"ListItem","position":2,"name":"NPipeline Observability Extension","item":"https://npipeline.dev/docs/extensions/observability/"},{"@type":"ListItem","position":3,"name":"Observability Usage Examples","item":"https://npipeline.dev/docs/extensions/observability/examples"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="NPipeline RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="NPipeline Atom Feed">





<script src="//script.crazyegg.com/pages/scripts/0131/6841.js" async="async"></script><link rel="stylesheet" href="/assets/css/styles.4bb8ba71.css">
<script src="/assets/js/runtime~main.f12a64a7.js" defer="defer"></script>
<script src="/assets/js/main.718883bb.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="NPipeline logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="NPipeline logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">NPipeline</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/npipeline/npipeline" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/"><span title="Welcome to NPipeline" class="linkLabel_WmDU">Welcome to NPipeline</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/getting-started"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/core-concepts"><span title="Core Concepts" class="categoryLinkLabel_W154">Core Concepts</span></a><button aria-label="Expand sidebar category &#x27;Core Concepts&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/architecture/"><span title="Architecture" class="categoryLinkLabel_W154">Architecture</span></a><button aria-label="Collapse sidebar category &#x27;Architecture&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/architectural-foundations"><span title="Architectural Foundations" class="linkLabel_WmDU">Architectural Foundations</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/component-architecture"><span title="Component Architecture" class="linkLabel_WmDU">Component Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/execution-flow"><span title="Execution Flow" class="linkLabel_WmDU">Execution Flow</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/data-flow"><span title="Data Flow Details" class="linkLabel_WmDU">Data Flow Details</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/dependency-injection"><span title="Dependency Injection Integration" class="linkLabel_WmDU">Dependency Injection Integration</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/node-instantiation"><span title="Node Instantiation" class="linkLabel_WmDU">Node Instantiation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/error-handling-architecture"><span title="Error Handling Architecture" class="linkLabel_WmDU">Error Handling Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/cancellation-model"><span title="Cancellation Model" class="linkLabel_WmDU">Cancellation Model</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/performance-characteristics"><span title="Performance Characteristics" class="linkLabel_WmDU">Performance Characteristics</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/retry-delay-architecture"><span title="Retry Delay Strategies Architecture" class="linkLabel_WmDU">Retry Delay Strategies Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/extension-points"><span title="Extension Points" class="linkLabel_WmDU">Extension Points</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/design-principles"><span title="Design Principles" class="linkLabel_WmDU">Design Principles</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/optimization-principles"><span title="Optimization Principles - How NPipeline Achieves High Performance" class="linkLabel_WmDU">Optimization Principles - How NPipeline Achieves High Performance</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/execution-plan-caching"><span title="Execution Plan Caching" class="linkLabel_WmDU">Execution Plan Caching</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/docs/extensions"><span title="Extensions" class="categoryLinkLabel_W154">Extensions</span></a><button aria-label="Collapse sidebar category &#x27;Extensions&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/dependency-injection"><span title="Dependency Injection" class="linkLabel_WmDU">Dependency Injection</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/parallelism"><span title="Parallelism" class="linkLabel_WmDU">Parallelism</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/extensions/testing"><span title="Testing" class="categoryLinkLabel_W154">Testing</span></a><button aria-label="Expand sidebar category &#x27;Testing&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/extensions/nodes"><span title="Nodes Extension" class="categoryLinkLabel_W154">Nodes Extension</span></a><button aria-label="Expand sidebar category &#x27;Nodes Extension&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/extensions/composition/"><span title="Pipeline Composition Extension" class="categoryLinkLabel_W154">Pipeline Composition Extension</span></a><button aria-label="Expand sidebar category &#x27;Pipeline Composition Extension&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/extensions/observability/"><span title="NPipeline Observability Extension" class="categoryLinkLabel_W154">NPipeline Observability Extension</span></a><button aria-label="Collapse sidebar category &#x27;NPipeline Observability Extension&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/observability/opentelemetry"><span title="OpenTelemetry Integration" class="linkLabel_WmDU">OpenTelemetry Integration</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/observability/tracing"><span title="Distributed Tracing" class="linkLabel_WmDU">Distributed Tracing</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/observability/advanced-patterns"><span title="Advanced Observability Patterns" class="linkLabel_WmDU">Advanced Observability Patterns</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/observability/configuration"><span title="Observability Configuration" class="linkLabel_WmDU">Observability Configuration</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/extensions/observability/examples"><span title="Observability Usage Examples" class="linkLabel_WmDU">Observability Usage Examples</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extensions/observability/metrics"><span title="Metrics Reference" class="linkLabel_WmDU">Metrics Reference</span></a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/connectors"><span title="Connectors" class="categoryLinkLabel_W154">Connectors</span></a><button aria-label="Expand sidebar category &#x27;Connectors&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/advanced-topics"><span title="Advanced Topics" class="categoryLinkLabel_W154">Advanced Topics</span></a><button aria-label="Expand sidebar category &#x27;Advanced Topics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/analyzers/"><span title="Build-Time Analyzers" class="categoryLinkLabel_W154">Build-Time Analyzers</span></a><button aria-label="Expand sidebar category &#x27;Build-Time Analyzers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/samples/"><span title="Samples" class="categoryLinkLabel_W154">Samples</span></a><button aria-label="Expand sidebar category &#x27;Samples&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/reference"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a><button aria-label="Expand sidebar category &#x27;Reference&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/extensions"><span>Extensions</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/extensions/observability/"><span>NPipeline Observability Extension</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Observability Usage Examples</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Observability Usage Examples</h1></header>
<p>This section provides complete, working code examples for common scenarios when using the NPipeline Observability extension.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="basic-usage-with-automatic-metrics-collection">Basic Usage with Automatic Metrics Collection<a href="#basic-usage-with-automatic-metrics-collection" class="hash-link" aria-label="Direct link to Basic Usage with Automatic Metrics Collection" title="Direct link to Basic Usage with Automatic Metrics Collection" translate="no">​</a></h2>
<p>The simplest way to enable observability is using the <code>IObservablePipelineContextFactory</code> with the default registration.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-1-quick-start-with-automatic-metrics">Example 1: Quick Start with Automatic Metrics<a href="#example-1-quick-start-with-automatic-metrics" class="hash-link" aria-label="Direct link to Example 1: Quick Start with Automatic Metrics" title="Direct link to Example 1: Quick Start with Automatic Metrics" translate="no">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.Hosting;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.Logging;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.DataFlow;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.DataFlow.DataPipes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Nodes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Pipeline;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Define a simple pipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SimplePipeline : IPipelineDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void Define(PipelineBuilder builder, PipelineContext context)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var source = builder.AddSource&lt;NumberSource, int&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var transform = builder.AddTransform&lt;DoubleTransform, int, int&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var sink = builder.AddSink&lt;NumberSink, int&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder.Connect(source, transform);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder.Connect(transform, sink);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Source node that generates numbers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class NumberSource : SourceNode&lt;int&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IDataPipe&lt;int&gt; ExecuteAsync(PipelineContext context, CancellationToken cancellationToken = default)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        static async IAsyncEnumerable&lt;int&gt; Generate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 1; i &lt;= 100; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                yield return i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new StreamingDataPipe&lt;int&gt;(Generate());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Transform node that doubles numbers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class DoubleTransform : TransformNode&lt;int, int&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public override Task&lt;int&gt; ExecuteAsync(int item, PipelineContext context, CancellationToken cancellationToken = default)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.FromResult(item * 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Sink node that outputs numbers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class NumberSink : SinkNode&lt;int&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task ExecuteAsync(IDataPipe&lt;int&gt; input, PipelineContext context, IPipelineActivity parentActivity, CancellationToken cancellationToken = default)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await foreach (var item in input.WithCancellation(cancellationToken))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Console.WriteLine($&quot;Received: {item}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Program setup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static async Task Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var host = Host.CreateDefaultBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ConfigureServices((context, services) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Add logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                services.AddLogging(loggingBuilder =&gt; loggingBuilder.AddConsole());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Add observability - automatically sets up metrics collection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                services.AddNPipelineObservability();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Register NPipeline core services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                services.AddNPipeline(typeof(Program).Assembly);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .Build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Create an async scope for proper resource management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await using var scope = host.Services.CreateAsyncScope();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var runner = scope.ServiceProvider.GetRequiredService&lt;IPipelineRunner&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var contextFactory = scope.ServiceProvider.GetRequiredService&lt;IObservablePipelineContextFactory&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var collector = scope.ServiceProvider.GetRequiredService&lt;IObservabilityCollector&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Create context with automatic observability enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await using var pipelineContext = contextFactory.Create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Run the pipeline - metrics are automatically collected!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await runner.RunAsync&lt;SimplePipeline&gt;(pipelineContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Display metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Console.WriteLine(&quot;\n=== Metrics Collected ===&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var metric in collector.GetNodeMetrics())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Console.WriteLine($&quot;Node {metric.NodeId}:&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Console.WriteLine($&quot;  Duration: {metric.DurationMs}ms&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Console.WriteLine($&quot;  Items Processed: {metric.ItemsProcessed}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Console.WriteLine($&quot;  Success: {metric.Success}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>What happens automatically:</strong></p>
<ul>
<li class=""><code>IObservablePipelineContextFactory</code> creates a context with <code>ExecutionObserver</code> pre-configured</li>
<li class="">No need to manually create <code>MetricsCollectingExecutionObserver</code> or wire it up</li>
<li class="">Metrics are collected by the framework during node execution</li>
<li class="">Default logging sink outputs metrics to the configured logger</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="custom-metrics-sink-example">Custom Metrics Sink Example<a href="#custom-metrics-sink-example" class="hash-link" aria-label="Direct link to Custom Metrics Sink Example" title="Direct link to Custom Metrics Sink Example" translate="no">​</a></h2>
<p>Create a custom metrics sink to send metrics to external monitoring systems like Application Insights, Prometheus, or a custom API.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-2-application-insights-integration">Example 2: Application Insights Integration<a href="#example-2-application-insights-integration" class="hash-link" aria-label="Direct link to Example 2: Application Insights Integration" title="Direct link to Example 2: Application Insights Integration" translate="no">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.ApplicationInsights;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.ApplicationInsights.DataContracts;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.Metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Custom sink for Application Insights</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class ApplicationInsightsMetricsSink : IMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly TelemetryClient _telemetryClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApplicationInsightsMetricsSink(TelemetryClient telemetryClient)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _telemetryClient = telemetryClient ?? throw new ArgumentNullException(nameof(telemetryClient));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Create a custom event with metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var properties = new Dictionary&lt;string, string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;NodeId&quot;] = nodeMetrics.NodeId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;Success&quot;] = nodeMetrics.Success.ToString(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;HasException&quot;] = (nodeMetrics.Exception != null).ToString()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var metrics = new Dictionary&lt;string, double&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;DurationMs&quot;] = nodeMetrics.DurationMs ?? 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;ItemsProcessed&quot;] = nodeMetrics.ItemsProcessed,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;ItemsEmitted&quot;] = nodeMetrics.ItemsEmitted,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;ThroughputItemsPerSec&quot;] = nodeMetrics.ThroughputItemsPerSec ?? 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;RetryCount&quot;] = nodeMetrics.RetryCount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nodeMetrics.PeakMemoryUsageMb.HasValue)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            metrics[&quot;PeakMemoryUsageMb&quot;] = nodeMetrics.PeakMemoryUsageMb.Value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nodeMetrics.ProcessorTimeMs.HasValue)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            metrics[&quot;ProcessorTimeMs&quot;] = nodeMetrics.ProcessorTimeMs.Value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _telemetryClient.TrackEvent(&quot;NodeCompleted&quot;, properties, metrics);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If node failed, track the exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!nodeMetrics.Success &amp;&amp; nodeMetrics.Exception != null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _telemetryClient.TrackException(nodeMetrics.Exception, properties);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Custom pipeline metrics sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class ApplicationInsightsPipelineMetricsSink : IPipelineMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly TelemetryClient _telemetryClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApplicationInsightsPipelineMetricsSink(TelemetryClient telemetryClient)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _telemetryClient = telemetryClient ?? throw new ArgumentNullException(nameof(telemetryClient));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Task RecordAsync(IPipelineMetrics pipelineMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var properties = new Dictionary&lt;string, string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;PipelineName&quot;] = pipelineMetrics.PipelineName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;RunId&quot;] = pipelineMetrics.RunId.ToString(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;Success&quot;] = pipelineMetrics.Success.ToString(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;NodeCount&quot;] = pipelineMetrics.NodeMetrics.Count.ToString()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var metrics = new Dictionary&lt;string, double&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;DurationMs&quot;] = pipelineMetrics.DurationMs ?? 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&quot;TotalItemsProcessed&quot;] = pipelineMetrics.TotalItemsProcessed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Calculate overall throughput</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pipelineMetrics.DurationMs.HasValue &amp;&amp; pipelineMetrics.DurationMs.Value &gt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var throughput = (double)pipelineMetrics.TotalItemsProcessed / (pipelineMetrics.DurationMs.Value / 1000.0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            metrics[&quot;ThroughputItemsPerSec&quot;] = throughput;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _telemetryClient.TrackEvent(&quot;PipelineCompleted&quot;, properties, metrics);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!pipelineMetrics.Success &amp;&amp; pipelineMetrics.Exception != null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _telemetryClient.TrackException(pipelineMetrics.Exception, properties);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Registration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static async Task Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Configure Application Insights</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var telemetryConfig = TelemetryConfiguration.CreateDefault();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        telemetryConfig.ConnectionString = &quot;InstrumentationKey=YOUR_KEY&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var telemetryClient = new TelemetryClient(telemetryConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddSingleton(telemetryClient);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Register custom sinks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipelineObservability&lt;ApplicationInsightsMetricsSink, ApplicationInsightsPipelineMetricsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Register NPipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipeline(typeof(Program).Assembly);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var serviceProvider = services.BuildServiceProvider();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await serviceProvider.RunPipelineAsync&lt;MyPipeline&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-3-prometheus-metrics-exporter">Example 3: Prometheus Metrics Exporter<a href="#example-3-prometheus-metrics-exporter" class="hash-link" aria-label="Direct link to Example 3: Prometheus Metrics Exporter" title="Direct link to Example 3: Prometheus Metrics Exporter" translate="no">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Prometheus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.Metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Prometheus metrics definitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class PrometheusMetricsSink : IMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static readonly Counter NodeExecutions = Metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .CreateCounter(&quot;npipeline_node_executions_total&quot;, &quot;Total number of node executions&quot;, &quot;node_id&quot;, &quot;success&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static readonly Histogram NodeDuration = Metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .CreateHistogram(&quot;npipeline_node_duration_seconds&quot;, &quot;Node execution duration in seconds&quot;, &quot;node_id&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static readonly Gauge NodeThroughput = Metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .CreateGauge(&quot;npipeline_node_throughput_items_per_second&quot;, &quot;Node throughput in items per second&quot;, &quot;node_id&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static readonly Counter NodeRetries = Metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .CreateCounter(&quot;npipeline_node_retries_total&quot;, &quot;Total number of node retries&quot;, &quot;node_id&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Record execution count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NodeExecutions.WithLabels(nodeMetrics.NodeId, nodeMetrics.Success.ToString()).Inc();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Record duration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nodeMetrics.DurationMs.HasValue)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            NodeDuration.WithLabels(nodeMetrics.NodeId).Observe(nodeMetrics.DurationMs.Value / 1000.0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Record throughput</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nodeMetrics.ThroughputItemsPerSec.HasValue)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            NodeThroughput.WithLabels(nodeMetrics.NodeId).Set(nodeMetrics.ThroughputItemsPerSec.Value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Record retries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nodeMetrics.RetryCount &gt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            NodeRetries.WithLabels(nodeMetrics.NodeId).Inc(nodeMetrics.RetryCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Registration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static async Task Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Start Prometheus metrics server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var metricServer = new KestrelMetricServer(port: 9090);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metricServer.Start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipelineObservability&lt;PrometheusMetricsSink, LoggingPipelineMetricsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipeline(typeof(Program).Assembly);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var serviceProvider = services.BuildServiceProvider();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await serviceProvider.RunPipelineAsync&lt;MyPipeline&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metricServer.Stop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="dependency-injection-integration-example">Dependency Injection Integration Example<a href="#dependency-injection-integration-example" class="hash-link" aria-label="Direct link to Dependency Injection Integration Example" title="Direct link to Dependency Injection Integration Example" translate="no">​</a></h2>
<p>Integrate observability with complex DI scenarios, including scoped services and constructor injection.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-4-pipeline-with-scoped-services">Example 4: Pipeline with Scoped Services<a href="#example-4-pipeline-with-scoped-services" class="hash-link" aria-label="Direct link to Example 4: Pipeline with Scoped Services" title="Direct link to Example 4: Pipeline with Scoped Services" translate="no">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.DataFlow;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Nodes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Scoped service for database access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface IDataRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Task SaveAsync&lt;T&gt;(T item);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataRepository : IDataRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ILogger&lt;DataRepository&gt; _logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataRepository(ILogger&lt;DataRepository&gt; logger)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger = logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task SaveAsync&lt;T&gt;(T item)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogInformation(&quot;Saving item of type {ItemType}&quot;, typeof(T).Name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await Task.Delay(10); // Simulate database operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Node that uses scoped service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class DatabaseSink&lt;T&gt; : SinkNode&lt;T&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IDataRepository _repository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DatabaseSink(IDataRepository repository)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _repository = repository ?? throw new ArgumentNullException(nameof(repository));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task ExecuteAsync(IDataPipe&lt;T&gt; input, PipelineContext context, IPipelineActivity parentActivity, CancellationToken cancellationToken = default)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await foreach (var item in input.WithCancellation(cancellationToken))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await _repository.SaveAsync(item);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Pipeline definition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataProcessingPipeline : IPipelineDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void Define(PipelineBuilder builder, PipelineContext context)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var source = builder.AddSource&lt;DataSource, DataItem&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var transform = builder.AddTransform&lt;DataTransform, DataItem, ProcessedData&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var sink = builder.AddSink&lt;DatabaseSink&lt;ProcessedData&gt;, ProcessedData&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder.Connect(source, transform);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder.Connect(transform, sink);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Program setup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static async Task Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddLogging(loggingBuilder =&gt; loggingBuilder.AddConsole());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add observability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipelineObservability();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Register scoped services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddScoped&lt;IDataRepository, DataRepository&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Register NPipeline with DI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipeline(typeof(Program).Assembly);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var serviceProvider = services.BuildServiceProvider();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Run pipeline - each run gets its own scoped services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await serviceProvider.RunPipelineAsync&lt;DataProcessingPipeline&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="advanced-scenarios">Advanced Scenarios<a href="#advanced-scenarios" class="hash-link" aria-label="Direct link to Advanced Scenarios" title="Direct link to Advanced Scenarios" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-5-multiple-observers-composite-pattern">Example 5: Multiple Observers (Composite Pattern)<a href="#example-5-multiple-observers-composite-pattern" class="hash-link" aria-label="Direct link to Example 5: Multiple Observers (Composite Pattern)" title="Direct link to Example 5: Multiple Observers (Composite Pattern)" translate="no">​</a></h3>
<p>Use multiple observers to collect different types of metrics or send metrics to multiple destinations.</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Execution;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Custom observer for error tracking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class ErrorTrackingObserver : IExecutionObserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ILogger _logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ErrorTrackingObserver(ILogger&lt;ErrorTrackingObserver&gt; logger)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger = logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void OnNodeStarted(NodeExecutionStarted e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // No action needed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void OnNodeCompleted(NodeExecutionCompleted e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!e.Success &amp;&amp; e.Error != null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _logger.LogError(e.Error, &quot;Node {NodeId} failed after {Duration}ms&quot;, e.NodeId, e.Duration.TotalMilliseconds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void OnRetry(NodeRetryEvent e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogWarning(&quot;Node {NodeId} retry attempt {Attempt}. Last error: {Error}&quot;, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.NodeId, e.Attempt, e.LastException?.Message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void OnDrop(QueueDropEvent e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogWarning(&quot;Dropped {ItemCount} items from queue {QueueId} due to backpressure&quot;, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.ItemCount, e.QueueId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void OnQueueMetrics(QueueMetricsEvent e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Track queue depth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogDebug(&quot;Queue {QueueId} depth: {Depth}&quot;, e.QueueId, e.Depth);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Composite observer that combines multiple observers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class CompositeObserver : IExecutionObserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IEnumerable&lt;IExecutionObserver&gt; _observers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CompositeObserver(IEnumerable&lt;IExecutionObserver&gt; observers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _observers = observers ?? throw new ArgumentNullException(nameof(observers));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void OnNodeStarted(NodeExecutionStarted e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var observer in _observers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            observer.OnNodeStarted(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void OnNodeCompleted(NodeExecutionCompleted e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var observer in _observers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            observer.OnNodeCompleted(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void OnRetry(NodeRetryEvent e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var observer in _observers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            observer.OnRetry(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void OnDrop(QueueDropEvent e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var observer in _observers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            observer.OnDrop(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void OnQueueMetrics(QueueMetricsEvent e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var observer in _observers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            observer.OnQueueMetrics(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Registration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static async Task Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddLogging(loggingBuilder =&gt; loggingBuilder.AddConsole());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add observability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipelineObservability();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Register custom observers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddSingleton&lt;IExecutionObserver, ErrorTrackingObserver&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddSingleton&lt;IExecutionObserver, MetricsCollectingExecutionObserver&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddSingleton&lt;IExecutionObserver, CompositeObserver&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipeline(typeof(Program).Assembly);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var serviceProvider = services.BuildServiceProvider();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await serviceProvider.RunPipelineAsync&lt;MyPipeline&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-6-custom-metrics-collection-with-enrichment">Example 6: Custom Metrics Collection with Enrichment<a href="#example-6-custom-metrics-collection-with-enrichment" class="hash-link" aria-label="Direct link to Example 6: Custom Metrics Collection with Enrichment" title="Direct link to Example 6: Custom Metrics Collection with Enrichment" translate="no">​</a></h3>
<p>Create a custom collector that enriches metrics with additional context.</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.Metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Custom collector that enriches metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class EnrichedObservabilityCollector : IObservabilityCollector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ObservabilityCollector _baseCollector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IHttpContextAccessor _httpContextAccessor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ILogger _logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EnrichedObservabilityCollector(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IHttpContextAccessor httpContextAccessor,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ILogger&lt;EnrichedObservabilityCollector&gt; logger)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector = new ObservabilityCollector();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _httpContextAccessor = httpContextAccessor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger = logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void RecordNodeStart(string nodeId, DateTimeOffset timestamp, int? threadId = null, long? initialMemoryMb = null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var correlationId = _httpContextAccessor.HttpContext?.TraceIdentifier;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogInformation(&quot;Node {NodeId} started. CorrelationId: {CorrelationId}&quot;, nodeId, correlationId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector.RecordNodeStart(nodeId, timestamp, threadId, initialMemoryMb);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void RecordNodeEnd(string nodeId, DateTimeOffset timestamp, bool success, Exception? exception = null, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long? peakMemoryMb = null, long? processorTimeMs = null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector.RecordNodeEnd(nodeId, timestamp, success, exception, peakMemoryMb, processorTimeMs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void RecordItemMetrics(string nodeId, long itemsProcessed, long itemsEmitted)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector.RecordItemMetrics(nodeId, itemsProcessed, itemsEmitted);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void RecordRetry(string nodeId, int retryCount, string? reason = null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogWarning(&quot;Node {NodeId} retry {RetryCount}. Reason: {Reason}&quot;, nodeId, retryCount, reason);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector.RecordRetry(nodeId, retryCount, reason);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void RecordPerformanceMetrics(string nodeId, double throughputItemsPerSec, double averageItemProcessingMs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _baseCollector.RecordPerformanceMetrics(nodeId, throughputItemsPerSec, averageItemProcessingMs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IReadOnlyList&lt;INodeMetrics&gt; GetNodeMetrics()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return _baseCollector.GetNodeMetrics();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public INodeMetrics? GetNodeMetrics(string nodeId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return _baseCollector.GetNodeMetrics(nodeId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IPipelineMetrics CreatePipelineMetrics(string pipelineName, Guid runId, DateTimeOffset startTime, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DateTimeOffset? endTime, bool success, Exception? exception = null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var baseMetrics = _baseCollector.CreatePipelineMetrics(pipelineName, runId, startTime, endTime, success, exception);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Enrich with additional context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var correlationId = _httpContextAccessor.HttpContext?.TraceIdentifier;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogInformation(&quot;Pipeline {PipelineName} completed. CorrelationId: {CorrelationId}&quot;, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pipelineName, correlationId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return baseMetrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Registration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static async Task Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddLogging(loggingBuilder =&gt; loggingBuilder.AddConsole());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddHttpContextAccessor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Register custom collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipelineObservability&lt;EnrichedObservabilityCollector, LoggingMetricsSink, LoggingPipelineMetricsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipeline(typeof(Program).Assembly);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var serviceProvider = services.BuildServiceProvider();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await serviceProvider.RunPipelineAsync&lt;MyPipeline&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-7-performance-monitoring-with-alerts">Example 7: Performance Monitoring with Alerts<a href="#example-7-performance-monitoring-with-alerts" class="hash-link" aria-label="Direct link to Example 7: Performance Monitoring with Alerts" title="Direct link to Example 7: Performance Monitoring with Alerts" translate="no">​</a></h3>
<p>Create a metrics sink that monitors performance and triggers alerts when thresholds are exceeded.</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.Metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Configuration for performance thresholds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class PerformanceThresholds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public double MaxNodeDurationMs { get; set; } = 5000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public double MinThroughputItemsPerSec { get; set; } = 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int MaxRetryCount { get; set; } = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Metrics sink with alerting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class AlertingMetricsSink : IMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly PerformanceThresholds _thresholds;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ILogger _logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AlertingMetricsSink(PerformanceThresholds thresholds, ILogger&lt;AlertingMetricsSink&gt; logger)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _thresholds = thresholds ?? throw new ArgumentNullException(nameof(thresholds));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger = logger ?? throw new ArgumentNullException(nameof(logger));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check for slow nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nodeMetrics.DurationMs.HasValue &amp;&amp; nodeMetrics.DurationMs.Value &gt; _thresholds.MaxNodeDurationMs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _logger.LogWarning(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;PERFORMANCE ALERT: Node {NodeId} exceeded duration threshold. &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Actual: {ActualMs}ms, Threshold: {ThresholdMs}ms&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.NodeId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.DurationMs.Value,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _thresholds.MaxNodeDurationMs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check for low throughput</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nodeMetrics.ThroughputItemsPerSec.HasValue &amp;&amp; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nodeMetrics.ThroughputItemsPerSec.Value &lt; _thresholds.MinThroughputItemsPerSec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _logger.LogWarning(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;PERFORMANCE ALERT: Node {NodeId} below throughput threshold. &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Actual: {ActualItems}/sec, Threshold: {ThresholdItems}/sec&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.NodeId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.ThroughputItemsPerSec.Value,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _thresholds.MinThroughputItemsPerSec);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check for excessive retries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nodeMetrics.RetryCount &gt; _thresholds.MaxRetryCount)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _logger.LogWarning(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;RELIABILITY ALERT: Node {NodeId} exceeded retry threshold. &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Actual: {ActualRetries}, Threshold: {ThresholdRetries}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.NodeId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.RetryCount,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _thresholds.MaxRetryCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Registration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static async Task Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddLogging(loggingBuilder =&gt; loggingBuilder.AddConsole());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Configure thresholds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var thresholds = new PerformanceThresholds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MaxNodeDurationMs = 3000,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MinThroughputItemsPerSec = 50,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MaxRetryCount = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddSingleton(thresholds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Register alerting sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipelineObservability&lt;AlertingMetricsSink, LoggingPipelineMetricsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipeline(typeof(Program).Assembly);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var serviceProvider = services.BuildServiceProvider();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await serviceProvider.RunPipelineAsync&lt;MyPipeline&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-8-error-tracking-and-analysis">Example 8: Error Tracking and Analysis<a href="#example-8-error-tracking-and-analysis" class="hash-link" aria-label="Direct link to Example 8: Error Tracking and Analysis" title="Direct link to Example 8: Error Tracking and Analysis" translate="no">​</a></h3>
<p>Track and analyze errors across pipeline executions to identify patterns.</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.Metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Collections.Concurrent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Error tracker for analyzing patterns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class ErrorTracker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ConcurrentDictionary&lt;string, ErrorStats&gt; _errorStats = new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void TrackError(string nodeId, Exception exception)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var errorType = exception.GetType().Name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var stats = _errorStats.GetOrAdd(errorType, _ =&gt; new ErrorStats());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stats.Increment(nodeId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IEnumerable&lt;ErrorStats&gt; GetErrorStats()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return _errorStats.Values.OrderByDescending(s =&gt; s.Count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class ErrorStats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ConcurrentDictionary&lt;string, int&gt; _nodeCounts = new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int Count { get; private set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string? MostFrequentNode { get; private set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void Increment(string nodeId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Interlocked.Increment(ref Count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _nodeCounts.AddOrUpdate(nodeId, 1, (_, count) =&gt; count + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MostFrequentNode = _nodeCounts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .OrderByDescending(kvp =&gt; kvp.Value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .FirstOrDefault().Key;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Metrics sink that tracks errors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class ErrorTrackingMetricsSink : IMetricsSink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ErrorTracker _errorTracker;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ILogger _logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ErrorTrackingMetricsSink(ErrorTracker errorTracker, ILogger&lt;ErrorTrackingMetricsSink&gt; logger)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _errorTracker = errorTracker ?? throw new ArgumentNullException(nameof(errorTracker));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger = logger ?? throw new ArgumentNullException(nameof(logger));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Task RecordAsync(INodeMetrics nodeMetrics, CancellationToken cancellationToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!nodeMetrics.Success &amp;&amp; nodeMetrics.Exception != null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _errorTracker.TrackError(nodeMetrics.NodeId, nodeMetrics.Exception);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _logger.LogError(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.Exception,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Error in node {NodeId}: {ErrorMessage}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.NodeId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nodeMetrics.Exception.Message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Registration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static async Task Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddLogging(loggingBuilder =&gt; loggingBuilder.AddConsole());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Register error tracker as singleton to persist across runs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddSingleton&lt;ErrorTracker&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Register error tracking sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipelineObservability&lt;ErrorTrackingMetricsSink, LoggingPipelineMetricsSink&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipeline(typeof(Program).Assembly);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var serviceProvider = services.BuildServiceProvider();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Run pipeline multiple times to collect error patterns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 10; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await serviceProvider.RunPipelineAsync&lt;MyPipeline&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Analyze error patterns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var errorTracker = serviceProvider.GetRequiredService&lt;ErrorTracker&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var errorStat in errorTracker.GetErrorStats())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Console.WriteLine($&quot;Error Type: {errorStat.GetType().Name}, Count: {errorStat.Count}, &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $&quot;Most Frequent Node: {errorStat.MostFrequentNode}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="complete-working-example">Complete Working Example<a href="#complete-working-example" class="hash-link" aria-label="Direct link to Complete Working Example" title="Direct link to Complete Working Example" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-9-end-to-end-etl-pipeline-with-observability">Example 9: End-to-End ETL Pipeline with Observability<a href="#example-9-end-to-end-etl-pipeline-with-observability" class="hash-link" aria-label="Direct link to Example 9: End-to-End ETL Pipeline with Observability" title="Direct link to Example 9: End-to-End ETL Pipeline with Observability" translate="no">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.Extensions.Logging;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.DataFlow;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.DataFlow.DataPipes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Nodes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Observability.DependencyInjection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using NPipeline.Pipeline;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Data models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed record RawData(int Id, string Value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed record ProcessedData(int Id, string Value, DateTime ProcessedAt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Pipeline definition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class EtlPipeline : IPipelineDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void Define(PipelineBuilder builder, PipelineContext context)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var source = builder.AddSource&lt;CsvDataSource, RawData&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var validate = builder.AddTransform&lt;DataValidationTransform, RawData, RawData&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var transform = builder.AddTransform&lt;DataTransform, RawData, ProcessedData&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var sink = builder.AddSink&lt;DatabaseSink, ProcessedData&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder.Connect(source, validate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder.Connect(validate, transform);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder.Connect(transform, sink);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Source: Read from CSV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class CsvDataSource : SourceNode&lt;RawData&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IDataPipe&lt;RawData&gt; ExecuteAsync(PipelineContext context, CancellationToken cancellationToken = default)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        static async IAsyncEnumerable&lt;RawData&gt; ReadFromCsv()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Simulate reading from CSV file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 1; i &lt;= 1000; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                await Task.Delay(1, cancellationToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                yield return new RawData(i, $&quot;Value_{i}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new StreamingDataPipe&lt;RawData&gt;(ReadFromCsv());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Transform: Validate data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class DataValidationTransform : TransformNode&lt;RawData, RawData&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public override Task&lt;RawData&gt; ExecuteAsync(RawData item, PipelineContext context, CancellationToken cancellationToken = default)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Simulate validation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (item.Id &lt;= 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ArgumentException($&quot;Invalid ID: {item.Id}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.FromResult(item);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Transform: Process data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class DataTransform : TransformNode&lt;RawData, ProcessedData&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public override Task&lt;ProcessedData&gt; ExecuteAsync(RawData item, PipelineContext context, CancellationToken cancellationToken = default)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var processed = new ProcessedData(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            item.Id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            item.Value.ToUpper(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DateTime.UtcNow);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Task.FromResult(processed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Sink: Write to database</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class DatabaseSink : SinkNode&lt;ProcessedData&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ILogger&lt;DatabaseSink&gt; _logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DatabaseSink(ILogger&lt;DatabaseSink&gt; logger)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger = logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task ExecuteAsync(IDataPipe&lt;ProcessedData&gt; input, PipelineContext context, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IPipelineActivity parentActivity, CancellationToken cancellationToken = default)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int count = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await foreach (var item in input.WithCancellation(cancellationToken))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Simulate database write</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await Task.Delay(1, cancellationToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            count++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogInformation(&quot;Wrote {Count} items to database&quot;, count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static async Task Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var services = new ServiceCollection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Configure logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddLogging(loggingBuilder =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loggingBuilder.AddConsole();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loggingBuilder.SetMinimumLevel(LogLevel.Information);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add observability with default logging sinks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipelineObservability();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Register NPipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        services.AddNPipeline(typeof(Program).Assembly);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var serviceProvider = services.BuildServiceProvider();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Console.WriteLine(&quot;Starting ETL Pipeline with Observability...&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Console.WriteLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Run the pipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await serviceProvider.RunPipelineAsync&lt;EtlPipeline&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Console.WriteLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Console.WriteLine(&quot;Pipeline execution completed. Check logs for detailed metrics.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="related-topics">Related Topics<a href="#related-topics" class="hash-link" aria-label="Direct link to Related Topics" title="Direct link to Related Topics" translate="no">​</a></h2>
<ul>
<li class=""><strong><a class="" href="/docs/extensions/observability/">Observability Overview</a></strong>: Introduction to observability features</li>
<li class=""><strong><a class="" href="/docs/extensions/observability/configuration">Configuration Guide</a></strong>: Setup and configuration options</li>
<li class=""><strong><a class="" href="/docs/extensions/observability/metrics">Metrics Reference</a></strong>: Detailed metrics documentation</li>
</ul></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/extensions/observability/configuration"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Observability Configuration</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/extensions/observability/metrics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Metrics Reference</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#basic-usage-with-automatic-metrics-collection" class="table-of-contents__link toc-highlight">Basic Usage with Automatic Metrics Collection</a><ul><li><a href="#example-1-quick-start-with-automatic-metrics" class="table-of-contents__link toc-highlight">Example 1: Quick Start with Automatic Metrics</a></li></ul></li><li><a href="#custom-metrics-sink-example" class="table-of-contents__link toc-highlight">Custom Metrics Sink Example</a><ul><li><a href="#example-2-application-insights-integration" class="table-of-contents__link toc-highlight">Example 2: Application Insights Integration</a></li><li><a href="#example-3-prometheus-metrics-exporter" class="table-of-contents__link toc-highlight">Example 3: Prometheus Metrics Exporter</a></li></ul></li><li><a href="#dependency-injection-integration-example" class="table-of-contents__link toc-highlight">Dependency Injection Integration Example</a><ul><li><a href="#example-4-pipeline-with-scoped-services" class="table-of-contents__link toc-highlight">Example 4: Pipeline with Scoped Services</a></li></ul></li><li><a href="#advanced-scenarios" class="table-of-contents__link toc-highlight">Advanced Scenarios</a><ul><li><a href="#example-5-multiple-observers-composite-pattern" class="table-of-contents__link toc-highlight">Example 5: Multiple Observers (Composite Pattern)</a></li><li><a href="#example-6-custom-metrics-collection-with-enrichment" class="table-of-contents__link toc-highlight">Example 6: Custom Metrics Collection with Enrichment</a></li><li><a href="#example-7-performance-monitoring-with-alerts" class="table-of-contents__link toc-highlight">Example 7: Performance Monitoring with Alerts</a></li><li><a href="#example-8-error-tracking-and-analysis" class="table-of-contents__link toc-highlight">Example 8: Error Tracking and Analysis</a></li></ul></li><li><a href="#complete-working-example" class="table-of-contents__link toc-highlight">Complete Working Example</a><ul><li><a href="#example-9-end-to-end-etl-pipeline-with-observability" class="table-of-contents__link toc-highlight">Example 9: End-to-End ETL Pipeline with Observability</a></li></ul></li><li><a href="#related-topics" class="table-of-contents__link toc-highlight">Related Topics</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/why-npipeline">Why NPipeline?</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/installation">Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/quick-start">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/core-concepts">Core Concepts</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/npipeline/npipeline" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">&nbsp;</div></div></div></footer></div>
</body>
</html>